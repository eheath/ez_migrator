#!/usr/bin/env ruby

require_relative '../lib/ez_migrator'
require_relative '../lib/db_connection'
require_relative '../lib/file_reader'
require_relative '../lib/config'
require_relative '../lib/file_writer'
require_relative '../lib/schema_version'

puts "Starting..."

if !!(ARGV[0] =~ /^generate$/) && !ARGV[1].nil?
  EzMigrator::Worker.new.generate ARGV[1]
end

if (%w(test dev qa prod).include? ARGV[0])

  config_obj = EzMigrator::Config.new({env: ARGV[0]})
  db_connection = EzMigrator::DbConnection.new( config_obj )
  ez_migrator = EzMigrator::Worker.new(db_connection: db_connection, config_obj: config_obj)

  if !!(ARGV[1] =~ /^migrate$/) && ARGV[2].nil?
    ez_migrator.migrate
  end

  if !!(ARGV[1] =~ /^pending$/)
    if ez_migrator.pending_migrations.count
      puts "Pending Migrations for env: #{config_obj.env}"
      puts ez_migrator.pending_migrations
    else
      puts "No pending migrations for environment #{config_obj.env}"
    end
  end


end
